<!DOCTYPE html>
<html>
<!--
/*!
 * Copyright Â© 2014 Rainer Rillke <lastname>@wikipedia.de
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to
 * deal in the Software without restriction, including without limitation the
 * rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
 * sell copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
 * IN THE SOFTWARE.
 */
-->

<head>
	<title>Opus Encoder</title>
	<meta charset="UTF-8">
	<script src="jquery.min.js"></script>
</head>

<body>
	<div id="body-content">
		<h1>Opus encoder</h1>
		<progress style="display: inline-block; text-align: center; width: 100%;" value="0" max="100">Your browser does not support this tool. Upgrade to a modern browser, please.</progress>
		<input id="com-file-analyzer-fileinput" autofocus="" type="file" />

		<script type='text/javascript'>
			var $prog = $('progress'),
				$console = $('#console'),
				$input = $('input'),
				worker = new Worker('worker/EmsWorkerProxy.js');

			$input.change(function() {
				var f = this.files[0],
					fr = new FileReader();

				$input.attr('disabled', 'disabled');

				fr.addEventListener('loadend', function() {
					var args = [
						f.name,
						'encoded.opus'
					];
					var storedFiles = {};
					storedFiles[f.name] = new Uint8Array(fr.result);
					var outData = {
						'encoded.opus': {
							'MIME': 'audio/ogg'
						}
					};
					worker.postMessage({
						command: 'encode',
						importRoot: '',
						args: args,
						outData: outData,
						fileData: storedFiles
					});
				});
				fr.readAsArrayBuffer(f);
			});

			worker.onmessage = function(e) {
				if (e.data && e.data.reply === 'progress') {
					vals = e.data.values;
					if (vals[1]) {
						$prog.val(vals[0] / vals[1] * 100);
					}
				} else if (e.data && e.data.reply === 'done') {
					$prog.val(100);
					for (fileName in e.data.values) {
						$('<a>')
							.text(fileName)
							.prop('href', window.URL.createObjectURL(e.data.values[fileName].blob))
							.insertAfter($input);
					}
				}
			};
		</script>
	</div>
</body>

</html>